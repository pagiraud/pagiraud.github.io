<!DOCTYPE html>
<html lang="fr">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://www.insolit.org/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://www.insolit.org/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="http://www.insolit.org/theme/font-awesome/css/font-awesome.min.css">


    <link href="http://www.insolit.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Insolit Atom">



  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />


<meta name="author" content="Pierre-Amiel Giraud" />
<meta name="description" content="Il sâ€™agit dâ€™une opÃ©ration somme toute assez triviale, mais les informations que lâ€™on peut trouver ici ou lÃ  Ã  ce sujet sont assez contradictoires voire erronÃ©es, y compris sur le propre site dâ€™Apache. Ã€ partir dâ€™Ã©lÃ©ments de rÃ©ponse Ã©parpillÃ©s sur le web, jâ€™ai pu ..." />
<meta name="keywords" content="SÃ©curitÃ©, Administration de serveur, SSL">
<meta property="og:site_name" content="Insolit"/>
<meta property="og:title" content="SÃ©curiser (SSL) plusieurs domaines sur une mÃªme adresse IP avec Apache2"/>
<meta property="og:description" content="Il sâ€™agit dâ€™une opÃ©ration somme toute assez triviale, mais les informations que lâ€™on peut trouver ici ou lÃ  Ã  ce sujet sont assez contradictoires voire erronÃ©es, y compris sur le propre site dâ€™Apache. Ã€ partir dâ€™Ã©lÃ©ments de rÃ©ponse Ã©parpillÃ©s sur le web, jâ€™ai pu ..."/>
<meta property="og:locale" content="fr_FR"/>
<meta property="og:url" content="http://www.insolit.org/securiser-ssl-plusieurs-domaines-sur-une-meme-adresse-ip-avec-apache2.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2012-07-23 08:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="http://www.insolit.org/author/pierre-amiel-giraud.html">
<meta property="article:section" content="Outils et astuces"/>
<meta property="article:tag" content="SÃ©curitÃ©"/>
<meta property="article:tag" content="Administration de serveur"/>
<meta property="article:tag" content="SSL"/>
<meta property="og:image" content="">
  <title>Insolit &ndash; SÃ©curiser (SSL) plusieurs domaines sur une mÃªme adresse IP avec Apache2</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://www.insolit.org">
        <img src="http://www.insolit.org/theme/img/profile.png" alt="Insolit" title="Insolit">
      </a>
      <h1><a href="http://www.insolit.org">Insolit</a></h1>
<p>Informatique, logiciels libres et territoires</p>      <nav>
        <ul class="list">
          <li><a href="http://www.insolit.org/isidore/" target="_blank">Plugins de recherche pour les collections Isidore</a></li>
          <li><a href="https://docgeo.hypotheses.org/" target="_blank">Doc'GÃ©o</a></li>
          <li><a href="http://www.saintseiya.tv/" target="_blank">Saint Seiya Database</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/pagiraud" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/insolit_blog" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://www.insolit.org">Home</a>
      <a href="/categories.html">CatÃ©gories</a>
      <a href="/archives.html">Archives</a>
      <a href="/tags.html">Ã‰tiquettes</a>
      <a href="http://www.insolit.org/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="securiser-ssl-plusieurs-domaines-sur-une-meme-adresse-ip-avec-apache2">SÃ©curiser (SSL) plusieurs domaines sur une mÃªme adresse IP avec Apache2</h1>
    <p>Posted on lun. 23 juillet 2012 in <a href="http://www.insolit.org/category/outils-et-astuces.html">Outils et astuces</a></p>
  </header>
  <div>
    <p>Il sâ€™agit dâ€™une opÃ©ration somme toute assez triviale, mais les informations que lâ€™on peut trouver ici ou lÃ  Ã  ce sujet sont assez contradictoires voire erronÃ©es, y compris sur le propre site dâ€™Apache. Ã€ partir dâ€™Ã©lÃ©ments de rÃ©ponse Ã©parpillÃ©s sur le web, jâ€™ai pu me dÃ©brouiller. Pour vous Ã©viter dâ€™avoir Ã  faire plusieurs essais et Ã  trier le bon grain de lâ€™ivraie, jâ€™ai dÃ©cidÃ© de rÃ©diger ce tutoriel qui vous guidera pas Ã  pas, depuis lâ€™activation du SSL sous Apache jusquâ€™Ã  la configuration des VirtualHosts.  </p>
<h1>Lâ€™expression du besoin</h1>
<p>Tout dâ€™abord, il sâ€™agit de savoir ce que lâ€™on entend par plusieurs domaines sur une mÃªme adresse IP. Ici, il faut entendre domaine au sens de <a href="https://fr.wikipedia.org/wiki/Fully_qualified_domain_name" title="Fully Qualified Domain Name">FQDN</a> sans point final. Vous Ãªtes concernÃ© par exemple si vous souhaitez sÃ©curiser deux sites avec deux noms de domaines diffÃ©rents hÃ©bergÃ©s sur la mÃªme machine, par exemple pour moi&#8239;:</p>
<ul>
<li>
<p><code>www.insolit.org</code></p>
</li>
<li>
<p><code>www.saintseiya.tv</code></p>
</li>
</ul>
<p>Vous lâ€™Ãªtes Ã©galement si vous souhaitez sÃ©curiser plusieurs sous-domaines Ã©galement hÃ©bergÃ©s sur la mÃªme machine, par exemple&#8239;:</p>
<ul>
<li>
<p><code>www.saintseiya.tv</code></p>
</li>
<li>
<p><code>forum.saintseiya.tv</code></p>
</li>
</ul>
<p>Vous pourriez trÃ¨s bien vous contenter de sÃ©curiser le sous-domaine www en rendant accessible le forum via www.saintseiya.tv/forum, mais la solution est moins esthÃ©tique. De plus, procÃ©der par sous-domaine rajoute un soupÃ§on de sÃ©curitÃ© Ã  votre site. Regardez par exemple vos logs Apache, vous comprendrez.</p>
<h1>VÃ©rification de lâ€™installation</h1>
<p>Pour rÃ©aliser les opÃ©rations qui suivent, votre installation doit supporter les <acronym title="Server Name Indication">SNI</acronym>. Autrement dit, vous devez disposer dâ€™au moins la version 0.9.8 dâ€™OpenSSL et 2.2.12 dâ€™Apache. Comme ces deux versions datent respectivement de 2007 et 2009, cela ne devrait poser aucun problÃ¨me sur des distributions rÃ©centes.</p>
<p>En principe, tous les paquets nÃ©cessaires sont installÃ©s par dÃ©faut sur les principales distributions de serveurs GNU/Linux. Au pire, un petit coup dâ€™apt-get, dâ€™aptitude, de yum ou autre et le tour est jouÃ©. ğŸ˜‰</p>
<h1>Obtenir les certificats&#8239;: le plat de rÃ©sistance</h1>
<p>Il y a bien sÃ»r la mÃ©thode simple (auto-signature), qui permet en une commande dâ€™obtenir un certificat. Si lâ€™utilisation que vous faites de votre serveur est purement privÃ©e, vous pouvez vous en contenter&#8239;:</p>
<div class="highlight"><pre><span></span>sudo make-ssl-cert /usr/share/ssl-cert/ssleay.cnf /etc/ssl/private/localhost.pem
</pre></div>


<p>Cependant, mÃªme dans le cas dâ€™une utilisation privÃ©e, cela ne me semble pas optimal. Lâ€™appel Ã  une autoritÃ© extÃ©rieure me paraÃ®t prÃ©fÃ©rable (et en plus Ã§a apprend les bonnes maniÃ¨res pour un usage public). Il existe plusieurs solutions gratuites de certification. Si vous avez un domaine chez <a href="http://www.gandi.net" title="Un registrar bien connu">Gandi</a>, vous avez droit Ã  un certificat gratuit par exemple <del>(que jâ€™ai gaspillÃ© en faisant nâ€™importe quoi)</del>. Il semblerait que <a href="http://startssl.com/" title="StartSSL, une solution gratuite de certification SSL">StartSSL</a> fournisse Ã©galement ce genre de service.</p>
<p>Pour ma part, jâ€™ai optÃ© pour <a href="http://www.cacert.org" title="CAcert">CAcert</a>, une autoritÃ© de certification gratuite et associative. Les certificats quâ€™elle fournit produisent une erreur de sÃ©curitÃ© (au moins avec Firefox), il vous faudra donc confirmer une exception permanente. CACert est donc Ã  Ã©viter si vous souhaitez faire un usage public de votre site sÃ©curisÃ©, sauf si vous avez Ã  faire Ã  un public web savvy, tel <a href="https://linuxfr.org" title="Da Linux French Page">DLFP</a>.</p>
<p>Bref, procÃ©dons.</p>
<h2>Quelques prÃ©liminaires&#8239;: inscription et vÃ©rification du nom de domaine</h2>
<p>Inscrivez-vous sur CAcert (il suffit de suivre les instructions), puis dans le menu de droite allez sur <strong>Domains &gt; Add</strong>. Entrez le nom de domaine que vous souhaitez sÃ©curiser, sans le sous-domaine. Dans mon cas ce fut&#8239;:</p>
<div class="highlight"><pre><span></span>insolit.org
</pre></div>


<p>Sur lâ€™Ã©cran suivant, vous devez choisir une adresse email vers laquelle envoyer une vÃ©rification dans une liste restreinte avec des choix du type webmaster@mondomaine.tld . Si vous ne possÃ©dez aucune des adresses rÃ©fÃ©rencÃ©es, votre registrar vous fournit sÃ»rement un service de redirection gratuit quâ€™il vous suffit dâ€™activer. Câ€™est le cas chez Gandi en tout cas. Suivez ensuite le reste des instructions.</p>
<h2>GÃ©nÃ©ration de la demande de signature de certificat sur votre serveur</h2>
<p>Nous allons Ã  prÃ©sent gÃ©nÃ©rer une demande de signature de certificat, ou <acronym title="Certificate Signing Request">CSR</acronym>, grÃ¢ce Ã  OpenSSL.</p>
<div class="highlight"><pre><span></span>openssl req -newkey rsa:2048 -subj /CN=*.domaine.tld -nodes -keyout domaine_cle_privee.pem -out domaine_csr.pem
</pre></div>


<p>Remplacez <em>.domaine.tld par votre domaine, par exemple </em>.insolit.org Vous pouvez choisir de prÃ©ciser le sous-domaine (www par exemple), mais cela signifiera que vous devrez faire autant de certificats que de sous-domaines Ã  sÃ©curiser. Vous pouvez aussi modifier le nom des fichiers de sortie Ã  votre convenance.</p>
<p>Ouvrez votre CSR et copiez TOUT son contenu.</p>
<h2>Installation du certificat gÃ©nÃ©rÃ© par CAcert</h2>
<p>Reconnectez-vous sur CAcert. Dans le panneau de droite, rendez-vous sur Server Certificates &gt; New. Collez lâ€™intÃ©gralitÃ© de votre CSR dans la boÃ®te de texte. VÃ©rifiez bien que le contenu de la boÃ®te commence par <code>-----BEGIN CERTIFICATE REQUEST-----</code> et se termine par <code>-----END CERTIFICATE REQUEST-----</code>. Cliquez sur Generate. Si vous avez bien suivi mes instructions, CAcert devrait vous retourner un Â«&#8239;joli&#8239;Â» certificat. Copiez-le et enregistrez-le sur votre serveur, sous le nom domaine_cert.pem par exemple.</p>
<p>Il sâ€™agit maintenant de dÃ©placer les fichiers dans un rÃ©pertoire appropriÃ©. Les commandes suivantes partent du principe que vous nâ€™avez pas modifiÃ© les noms de fichiers proposÃ©s plus haut.</p>
<div class="highlight"><pre><span></span>sudo mv domaine_cert.pem /etc/ssl/certs/ &amp;&amp; sudo mv domaine_cle_privee.pem /etc/ssl/priv/
</pre></div>


<p>Vous pouvez conserver votre CSR si Ã§a vous amuse, mais il ne vous servira dÃ©sormais plus Ã  rien. Un petit coup de rm devrait lui rÃ©gler son compte.</p>
<h1>Configuration dâ€™Apache</h1>
<h2>Mise en place des hÃ´tes virtuels basÃ©s sur des noms</h2>
<p>Ils sont plus couramment appelÃ©s par leur nom anglais, name-based virtual hosts. On va commencer, si ce nâ€™est dÃ©jÃ  fait, par activer le module SSL dâ€™Apache&#8239;:</p>
<div class="highlight"><pre><span></span>sudo a2enmod ssl
</pre></div>


<p>Puis, ouvrez le fichier <em>/etc/apache2/ports.conf</em> et ajoutez la ligne</p>
<div class="highlight"><pre><span></span>NameVirtualHost *:443
</pre></div>


<p>juste aprÃ¨s celle quasi identique portant sur le port 80. Assurez-vous Ã©galement que la directive <em>Listen 443</em> nâ€™est pas commentÃ©e. vous devriez donc avoir, au minimum&#8239;:</p>
<div class="highlight"><pre><span></span>NameVirtualHost *:80
NameVirtualHost *:443

Listen 80

<span class="nt">&lt;IfModule</span> <span class="err">mod_ssl.c</span><span class="nt">&gt;</span>
    Listen 443
<span class="nt">&lt;/IfModule&gt;</span>
</pre></div>


<h2>CrÃ©er les fichiers de configuration des hÃ´tes virtuels</h2>
<p>Il sâ€™agit simplement de copier un hÃ´te virtuel fonctionnel en accÃ¨s non sÃ©curisÃ© (de type http) et de le modifier en ajoutant les lignes spÃ©cifiques au SSL.</p>
<p>On commence donc par copier le fichier de configuration&#8239;:</p>
<div class="highlight"><pre><span></span>sudo cp /etc/apache2/sites-available/{domaine,domaine_ssl}
</pre></div>


<p>Ouvrez ensuite le fichier domaine_ssl. Lâ€™une des premiÃ¨res lignes devrait Ãªtre <code>&lt;VirtualHost *:80&gt;</code>. Remplacez le 80 par 443. Rajoutez une ligne pour activer le SSL aprÃ¨s la dÃ©claration du ServerName&#8239;:</p>
<div class="highlight"><pre><span></span>SSLEngine On
</pre></div>


<p>Ã€ la suite, indiquez la localisation de votre clÃ© privÃ©e et de votre certificat&#8239;:</p>
<div class="highlight"><pre><span></span>SSLCertificateFile /etc/ssl/certs/domaine_cert.pem
SSLCertificateKeyFile /ssl/certs/priv/domaine_cle_privee.pem
</pre></div>


<p>Et câ€™est tout&#8239;! Recommencez cette derniÃ¨re opÃ©ration pour tous les sous-domaines nÃ©cessaires. Si vous possÃ©dez plusieurs noms de domaines sur la mÃªme machine, pensez bien Ã  gÃ©nÃ©rer un certificat par domaine. On active lâ€™hÃ´te virtuel et on teste&#8239;:</p>
<div class="highlight"><pre><span></span>sudo a2ensite domaine_ssl
/etc/init.d/apache2 reload
</pre></div>


<h1>Conclusion et crÃ©dits</h1>
<p>Normalement, tout devrait fonctionner. Si ce nâ€™est pas le cas, pensez Ã  consulter les logs dâ€™Apache pour en savoir plus.</p>
<p>Jâ€™ai rÃ©alisÃ© ce tutoriel en en croisant 3 partiels / incomplets&#8239;:</p>
<ol>
<li><a href="http://doc.ubuntu-fr.org/tutoriel/securiser_apache2_avec_ssl" title="SÃ©curiser Apache2 avec SSL">SÃ©curiser Apache2 avec SSL</a>, du wiki Ubuntu-fr&#8239;;</li>
<li><a href="http://wiki.cacert.org/SimpleApacheCert" title="Simple Apache Cert">Simple Apache Cert</a>, du wiki de CACert&#8239;;</li>
<li><a href="http://www.codealpha.net/631/name-based-virtual-hosts-with-ssl-using-apache2-on-ubuntu-lucid/" title="Billet du blog code(alpha)">Name Based Virtual Hosts with SSL using Apache2 on Ubuntu Lucid</a>, sur le blog code(alpha).</li>
</ol>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://www.insolit.org/tag/securite.html">SÃ©curitÃ©</a>
      <a href="http://www.insolit.org/tag/administration-de-serveur.html">Administration de serveur</a>
      <a href="http://www.insolit.org/tag/ssl.html">SSL</a>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'insolit';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
<p>
  &copy; Pierre-Amiel Giraud  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Insolit ",
  "url" : "http://www.insolit.org",
  "image": "",
  "description": ""
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "SÃ©curiser (SSL) plusieurs domaines sur une mÃªme adresse IP avec Apache2",
  "headline": "SÃ©curiser (SSL) plusieurs domaines sur une mÃªme adresse IP avec Apache2",
  "datePublished": "2012-07-23 08:00:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Pierre-Amiel Giraud",
    "url": "http://www.insolit.org/author/pierre-amiel-giraud.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "http://www.insolit.org/securiser-ssl-plusieurs-domaines-sur-une-meme-adresse-ip-avec-apache2.html",
  "description": "Il sâ€™agit dâ€™une opÃ©ration somme toute assez triviale, mais les informations que lâ€™on peut trouver ici ou lÃ  Ã  ce sujet sont assez contradictoires voire erronÃ©es, y compris sur le propre site dâ€™Apache. Ã€ partir dâ€™Ã©lÃ©ments de rÃ©ponse Ã©parpillÃ©s sur le web, jâ€™ai pu ..."
}
</script></body>
</html>