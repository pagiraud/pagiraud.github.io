<!DOCTYPE html>
<html lang="fr">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://www.insolit.org/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://www.insolit.org/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="http://www.insolit.org/theme/font-awesome/css/font-awesome.min.css">


    <link href="http://www.insolit.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Insolit Atom">



  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />


<meta name="author" content="Pierre-Amiel Giraud" />
<meta name="description" content="Il s‚Äôagit d‚Äôune op√©ration somme toute assez triviale, mais les informations que l‚Äôon peut trouver ici ou l√† √† ce sujet sont assez contradictoires voire erron√©es, y compris sur le propre site d‚ÄôApache. √Ä partir d‚Äô√©l√©ments de r√©ponse √©parpill√©s sur le web, j‚Äôai pu ..." />
<meta name="keywords" content="S√©curit√©, Administration de serveur, SSL">
<meta property="og:site_name" content="Insolit"/>
<meta property="og:title" content="S√©curiser (SSL) plusieurs domaines sur une m√™me adresse IP avec Apache2"/>
<meta property="og:description" content="Il s‚Äôagit d‚Äôune op√©ration somme toute assez triviale, mais les informations que l‚Äôon peut trouver ici ou l√† √† ce sujet sont assez contradictoires voire erron√©es, y compris sur le propre site d‚ÄôApache. √Ä partir d‚Äô√©l√©ments de r√©ponse √©parpill√©s sur le web, j‚Äôai pu ..."/>
<meta property="og:locale" content="fr_FR"/>
<meta property="og:url" content="http://www.insolit.org/securiser-ssl-plusieurs-domaines-sur-une-meme-adresse-ip-avec-apache2.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2012-07-23 08:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="http://www.insolit.org/author/pierre-amiel-giraud.html">
<meta property="article:section" content="Outils et astuces"/>
<meta property="article:tag" content="S√©curit√©"/>
<meta property="article:tag" content="Administration de serveur"/>
<meta property="article:tag" content="SSL"/>
<meta property="og:image" content="">
  <title>Insolit &ndash; S√©curiser (SSL) plusieurs domaines sur une m√™me adresse IP avec Apache2</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://www.insolit.org">
        <img src="http://www.insolit.org/theme/img/profile.png" alt="Insolit" title="Insolit">
      </a>
      <h1><a href="http://www.insolit.org">Insolit</a></h1>
<p>Informatique, logiciels libres et territoires</p>      <nav>
        <ul class="list">
          <li><a href="http://www.insolit.org/isidore/" target="_blank">Plugins de recherche pour les collections Isidore</a></li>
          <li><a href="https://docgeo.hypotheses.org/" target="_blank">Doc'G√©o</a></li>
          <li><a href="http://www.saintseiya.tv/" target="_blank">Saint Seiya Database</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/pagiraud" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/insolit_blog" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://www.insolit.org">Home</a>
      <a href="/categories.html">Cat√©gories</a>
      <a href="/archives.html">Archives</a>
      <a href="/tags.html">√âtiquettes</a>
      <a href="http://www.insolit.org/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="securiser-ssl-plusieurs-domaines-sur-une-meme-adresse-ip-avec-apache2">S√©curiser (SSL) plusieurs domaines sur une m√™me adresse IP avec Apache2</h1>
    <p>Posted on lun. 23 juillet 2012 in <a href="http://www.insolit.org/category/outils-et-astuces.html">Outils et astuces</a></p>
  </header>
  <div>
    <p>Il s‚Äôagit d‚Äôune op√©ration somme toute assez triviale, mais les informations que l‚Äôon peut trouver ici ou l√† √† ce sujet sont assez contradictoires voire erron√©es, y compris sur le propre site d‚ÄôApache. √Ä partir d‚Äô√©l√©ments de r√©ponse √©parpill√©s sur le web, j‚Äôai pu me d√©brouiller. Pour vous √©viter d‚Äôavoir √† faire plusieurs essais et √† trier le bon grain de l‚Äôivraie, j‚Äôai d√©cid√© de r√©diger ce tutoriel qui vous guidera pas √† pas, depuis l‚Äôactivation du SSL sous Apache jusqu‚Äô√† la configuration des VirtualHosts.  </p>
<h1>L‚Äôexpression du besoin</h1>
<p>Tout d‚Äôabord, il s‚Äôagit de savoir ce que l‚Äôon entend par plusieurs domaines sur une m√™me adresse IP. Ici, il faut entendre domaine au sens de <a href="https://fr.wikipedia.org/wiki/Fully_qualified_domain_name" title="Fully Qualified Domain Name">FQDN</a> sans point final. Vous √™tes concern√© par exemple si vous souhaitez s√©curiser deux sites avec deux noms de domaines diff√©rents h√©berg√©s sur la m√™me machine, par exemple pour moi&#8239;:</p>
<ul>
<li>
<p><code>www.insolit.org</code></p>
</li>
<li>
<p><code>www.saintseiya.tv</code></p>
</li>
</ul>
<p>Vous l‚Äô√™tes √©galement si vous souhaitez s√©curiser plusieurs sous-domaines √©galement h√©berg√©s sur la m√™me machine, par exemple&#8239;:</p>
<ul>
<li>
<p><code>www.saintseiya.tv</code></p>
</li>
<li>
<p><code>forum.saintseiya.tv</code></p>
</li>
</ul>
<p>Vous pourriez tr√®s bien vous contenter de s√©curiser le sous-domaine www en rendant accessible le forum via www.saintseiya.tv/forum, mais la solution est moins esth√©tique. De plus, proc√©der par sous-domaine rajoute un soup√ßon de s√©curit√© √† votre site. Regardez par exemple vos logs Apache, vous comprendrez.</p>
<h1>V√©rification de l‚Äôinstallation</h1>
<p>Pour r√©aliser les op√©rations qui suivent, votre installation doit supporter les <acronym title="Server Name Indication">SNI</acronym>. Autrement dit, vous devez disposer d‚Äôau moins la version 0.9.8 d‚ÄôOpenSSL et 2.2.12 d‚ÄôApache. Comme ces deux versions datent respectivement de 2007 et 2009, cela ne devrait poser aucun probl√®me sur des distributions r√©centes.</p>
<p>En principe, tous les paquets n√©cessaires sont install√©s par d√©faut sur les principales distributions de serveurs GNU/Linux. Au pire, un petit coup d‚Äôapt-get, d‚Äôaptitude, de yum ou autre et le tour est jou√©. üòâ</p>
<h1>Obtenir les certificats&#8239;: le plat de r√©sistance</h1>
<p>Il y a bien s√ªr la m√©thode simple (auto-signature), qui permet en une commande d‚Äôobtenir un certificat. Si l‚Äôutilisation que vous faites de votre serveur est purement priv√©e, vous pouvez vous en contenter&#8239;:</p>
<div class="highlight"><pre><span></span>sudo make-ssl-cert /usr/share/ssl-cert/ssleay.cnf /etc/ssl/private/localhost.pem
</pre></div>


<p>Cependant, m√™me dans le cas d‚Äôune utilisation priv√©e, cela ne me semble pas optimal. L‚Äôappel √† une autorit√© ext√©rieure me para√Æt pr√©f√©rable (et en plus √ßa apprend les bonnes mani√®res pour un usage public). Il existe plusieurs solutions gratuites de certification. Si vous avez un domaine chez <a href="http://www.gandi.net" title="Un registrar bien connu">Gandi</a>, vous avez droit √† un certificat gratuit par exemple <del>(que j‚Äôai gaspill√© en faisant n‚Äôimporte quoi)</del>. Il semblerait que <a href="http://startssl.com/" title="StartSSL, une solution gratuite de certification SSL">StartSSL</a> fournisse √©galement ce genre de service.</p>
<p>Pour ma part, j‚Äôai opt√© pour <a href="http://www.cacert.org" title="CAcert">CAcert</a>, une autorit√© de certification gratuite et associative. Les certificats qu‚Äôelle fournit produisent une erreur de s√©curit√© (au moins avec Firefox), il vous faudra donc confirmer une exception permanente. CACert est donc √† √©viter si vous souhaitez faire un usage public de votre site s√©curis√©, sauf si vous avez √† faire √† un public web savvy, tel <a href="https://linuxfr.org" title="Da Linux French Page">DLFP</a>.</p>
<p>Bref, proc√©dons.</p>
<h2>Quelques pr√©liminaires&#8239;: inscription et v√©rification du nom de domaine</h2>
<p>Inscrivez-vous sur CAcert (il suffit de suivre les instructions), puis dans le menu de droite allez sur <strong>Domains &gt; Add</strong>. Entrez le nom de domaine que vous souhaitez s√©curiser, sans le sous-domaine. Dans mon cas ce fut&#8239;:</p>
<div class="highlight"><pre><span></span>insolit.org
</pre></div>


<p>Sur l‚Äô√©cran suivant, vous devez choisir une adresse email vers laquelle envoyer une v√©rification dans une liste restreinte avec des choix du type webmaster@mondomaine.tld . Si vous ne poss√©dez aucune des adresses r√©f√©renc√©es, votre registrar vous fournit s√ªrement un service de redirection gratuit qu‚Äôil vous suffit d‚Äôactiver. C‚Äôest le cas chez Gandi en tout cas. Suivez ensuite le reste des instructions.</p>
<h2>G√©n√©ration de la demande de signature de certificat sur votre serveur</h2>
<p>Nous allons √† pr√©sent g√©n√©rer une demande de signature de certificat, ou <acronym title="Certificate Signing Request">CSR</acronym>, gr√¢ce √† OpenSSL.</p>
<div class="highlight"><pre><span></span>openssl req -newkey rsa:2048 -subj /CN=*.domaine.tld -nodes -keyout domaine_cle_privee.pem -out domaine_csr.pem
</pre></div>


<p>Remplacez <em>.domaine.tld par votre domaine, par exemple </em>.insolit.org Vous pouvez choisir de pr√©ciser le sous-domaine (www par exemple), mais cela signifiera que vous devrez faire autant de certificats que de sous-domaines √† s√©curiser. Vous pouvez aussi modifier le nom des fichiers de sortie √† votre convenance.</p>
<p>Ouvrez votre CSR et copiez TOUT son contenu.</p>
<h2>Installation du certificat g√©n√©r√© par CAcert</h2>
<p>Reconnectez-vous sur CAcert. Dans le panneau de droite, rendez-vous sur Server Certificates &gt; New. Collez l‚Äôint√©gralit√© de votre CSR dans la bo√Æte de texte. V√©rifiez bien que le contenu de la bo√Æte commence par <code>-----BEGIN CERTIFICATE REQUEST-----</code> et se termine par <code>-----END CERTIFICATE REQUEST-----</code>. Cliquez sur Generate. Si vous avez bien suivi mes instructions, CAcert devrait vous retourner un ¬´&#8239;joli&#8239;¬ª certificat. Copiez-le et enregistrez-le sur votre serveur, sous le nom domaine_cert.pem par exemple.</p>
<p>Il s‚Äôagit maintenant de d√©placer les fichiers dans un r√©pertoire appropri√©. Les commandes suivantes partent du principe que vous n‚Äôavez pas modifi√© les noms de fichiers propos√©s plus haut.</p>
<div class="highlight"><pre><span></span>sudo mv domaine_cert.pem /etc/ssl/certs/ &amp;&amp; sudo mv domaine_cle_privee.pem /etc/ssl/priv/
</pre></div>


<p>Vous pouvez conserver votre CSR si √ßa vous amuse, mais il ne vous servira d√©sormais plus √† rien. Un petit coup de rm devrait lui r√©gler son compte.</p>
<h1>Configuration d‚ÄôApache</h1>
<h2>Mise en place des h√¥tes virtuels bas√©s sur des noms</h2>
<p>Ils sont plus couramment appel√©s par leur nom anglais, name-based virtual hosts. On va commencer, si ce n‚Äôest d√©j√† fait, par activer le module SSL d‚ÄôApache&#8239;:</p>
<div class="highlight"><pre><span></span>sudo a2enmod ssl
</pre></div>


<p>Puis, ouvrez le fichier <em>/etc/apache2/ports.conf</em> et ajoutez la ligne</p>
<div class="highlight"><pre><span></span>NameVirtualHost *:443
</pre></div>


<p>juste apr√®s celle quasi identique portant sur le port 80. Assurez-vous √©galement que la directive <em>Listen 443</em> n‚Äôest pas comment√©e. vous devriez donc avoir, au minimum&#8239;:</p>
<div class="highlight"><pre><span></span>NameVirtualHost *:80
NameVirtualHost *:443

Listen 80

<span class="nt">&lt;IfModule</span> <span class="err">mod_ssl.c</span><span class="nt">&gt;</span>
    Listen 443
<span class="nt">&lt;/IfModule&gt;</span>
</pre></div>


<h2>Cr√©er les fichiers de configuration des h√¥tes virtuels</h2>
<p>Il s‚Äôagit simplement de copier un h√¥te virtuel fonctionnel en acc√®s non s√©curis√© (de type http) et de le modifier en ajoutant les lignes sp√©cifiques au SSL.</p>
<p>On commence donc par copier le fichier de configuration&#8239;:</p>
<div class="highlight"><pre><span></span>sudo cp /etc/apache2/sites-available/{domaine,domaine_ssl}
</pre></div>


<p>Ouvrez ensuite le fichier domaine_ssl. L‚Äôune des premi√®res lignes devrait √™tre <code>&lt;VirtualHost *:80&gt;</code>. Remplacez le 80 par 443. Rajoutez une ligne pour activer le SSL apr√®s la d√©claration du ServerName&#8239;:</p>
<div class="highlight"><pre><span></span>SSLEngine On
</pre></div>


<p>√Ä la suite, indiquez la localisation de votre cl√© priv√©e et de votre certificat&#8239;:</p>
<div class="highlight"><pre><span></span>SSLCertificateFile /etc/ssl/certs/domaine_cert.pem
SSLCertificateKeyFile /ssl/certs/priv/domaine_cle_privee.pem
</pre></div>


<p>Et c‚Äôest tout&#8239;! Recommencez cette derni√®re op√©ration pour tous les sous-domaines n√©cessaires. Si vous poss√©dez plusieurs noms de domaines sur la m√™me machine, pensez bien √† g√©n√©rer un certificat par domaine. On active l‚Äôh√¥te virtuel et on teste&#8239;:</p>
<div class="highlight"><pre><span></span>sudo a2ensite domaine_ssl
/etc/init.d/apache2 reload
</pre></div>


<h1>Conclusion et cr√©dits</h1>
<p>Normalement, tout devrait fonctionner. Si ce n‚Äôest pas le cas, pensez √† consulter les logs d‚ÄôApache pour en savoir plus.</p>
<p>J‚Äôai r√©alis√© ce tutoriel en en croisant 3 partiels / incomplets&#8239;:</p>
<ol>
<li><a href="http://doc.ubuntu-fr.org/tutoriel/securiser_apache2_avec_ssl" title="S√©curiser Apache2 avec SSL">S√©curiser Apache2 avec SSL</a>, du wiki Ubuntu-fr&#8239;;</li>
<li><a href="http://wiki.cacert.org/SimpleApacheCert" title="Simple Apache Cert">Simple Apache Cert</a>, du wiki de CACert&#8239;;</li>
<li><a href="http://www.codealpha.net/631/name-based-virtual-hosts-with-ssl-using-apache2-on-ubuntu-lucid/" title="Billet du blog code(alpha)">Name Based Virtual Hosts with SSL using Apache2 on Ubuntu Lucid</a>, sur le blog code(alpha).</li>
</ol>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://www.insolit.org/tag/securite.html">S√©curit√©</a>
      <a href="http://www.insolit.org/tag/administration-de-serveur.html">Administration de serveur</a>
      <a href="http://www.insolit.org/tag/ssl.html">SSL</a>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'insolit';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
<p>
  &copy; Pierre-Amiel Giraud  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Insolit ",
  "url" : "http://www.insolit.org",
  "image": "",
  "description": ""
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "S√©curiser (SSL) plusieurs domaines sur une m√™me adresse IP avec Apache2",
  "headline": "S√©curiser (SSL) plusieurs domaines sur une m√™me adresse IP avec Apache2",
  "datePublished": "2012-07-23 08:00:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Pierre-Amiel Giraud",
    "url": "http://www.insolit.org/author/pierre-amiel-giraud.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "http://www.insolit.org/securiser-ssl-plusieurs-domaines-sur-une-meme-adresse-ip-avec-apache2.html",
  "description": "Il s‚Äôagit d‚Äôune op√©ration somme toute assez triviale, mais les informations que l‚Äôon peut trouver ici ou l√† √† ce sujet sont assez contradictoires voire erron√©es, y compris sur le propre site d‚ÄôApache. √Ä partir d‚Äô√©l√©ments de r√©ponse √©parpill√©s sur le web, j‚Äôai pu ..."
}
</script></body>
</html>